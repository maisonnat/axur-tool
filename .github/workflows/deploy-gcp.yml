name: Deploy Backend to Google Cloud Run (Free Tier)

on:
  push:
    branches: [ "main" ]
    paths:
      - 'crates/**'
      - 'Cargo.toml'
      - 'Dockerfile'
      - '.github/workflows/deploy-gcp.yml'
  workflow_dispatch:

env:
  PROJECT_ID: axur-backend-free # TODO: Verificar si este es el ID exacto
  REGION: us-central1          # REQUERIDO para Free Tier
  REPO_NAME: axur-repo
  SERVICE_NAME: axur-backend
  IMAGE_NAME: axur-backend

jobs:
  deploy-to-gcp:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1.a Generate Context Packet (Repomix)
      - name: Pack Codebase with Repomix
        uses: yamadashy/repomix-action@v0.1.25 # Using latest compatible version
        with:
          output: codebase_context.xml
          style: xml

      - name: Upload Context Artifact
        uses: actions/upload-artifact@v4
        with:
          name: codebase_context
          path: codebase_context.xml
          retention-days: 7


      # 1. Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 2. Set up Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # 3. Setup Rust and Build Binary
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build Backend (Release)
        run: |
          cargo build --release --bin axur-backend
          cp target/release/axur-backend . # Move binary to root for Docker context

      # 4. Configure Docker for Artifact Registry
      - name: Configure Docker
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # 5. Build Docker Image
      - name: Build Docker Image
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest

      # 6. Push Docker Image
      - name: Push Docker Image
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest

      # 7. Deploy to Cloud Run
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          flags: '--allow-unauthenticated --memory=512Mi --cpu=1 --max-instances=1' # LIMITS FOR FREE TIER SAFETY
          env_vars: |
            RUST_LOG=info
            AXUR_API_TOKEN=${{ secrets.AXUR_API_TOKEN }}
            GIT_HASH=${{ github.sha }}
            FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
            FIREBASE_SERVICE_ACCOUNT_B64=${{ secrets.FIREBASE_SERVICE_ACCOUNT_B64 }}

      # 7. CLEANUP: Delete old images to stay within 500MB Free Tier limit
      - name: Delete Old Images (Safety Cleanup)
        run: |
          echo "Keeping only the last 3 images to save storage..."
          gcloud artifacts docker images list ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }} \
            --sort-by="~UPDATE_TIME" \
            --format="value(DIGEST)" \
            | tail -n +4 \
            | xargs -I {} gcloud artifacts docker images delete ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}@{} --delete-tags --quiet || true
